trigger:
  - main  # Trigger pipeline on changes to main branch

pool:
  name: "SelfHostedAgents"  # Use your self-hosted agent pool

steps:
  # Step 1: Checkout the repository
  - checkout: self  # Explicit checkout step

  # Step 2: Create an artifact
  - script: |
      echo "Hello World!" > artifact3.txt
      mkdir -p $(Build.ArtifactStagingDirectory)
      mv artifact3.txt $(Build.ArtifactStagingDirectory)/
    displayName: 'Create Artifact'

  # Step 3: Publish the artifact
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Artifact'
    inputs:
      pathToPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: 'my-artifact'
      publishLocation: 'Container'

  # Step 4: Download the artifact
  - task: DownloadBuildArtifacts@0
    displayName: 'Download Artifact'
    inputs:
      artifactName: 'my-artifact'
      downloadPath: '$(Build.ArtifactStagingDirectory)'

  # Step 5: Ensure azureuser has the right permissions to /sftp/uploads
  - script: |
      sshpass -p "$(SFTP_PASSWORD)" ssh -o StrictHostKeyChecking=no azureuser@$(SFTP_SERVER_IP) \
      "sudo mkdir -p /sftp/uploads && sudo chown -R azureuser:azureuser /sftp/uploads && sudo chmod -R 755 /sftp/uploads"
    displayName: 'Ensure Permissions on SFTP Server'
    env:
      SFTP_PASSWORD: $(sftp_password)
      SFTP_SERVER_IP: $(sftp_server_ip)

  # Step 6: Copy artifact to SFTP server using azureuser
  - script: |
      sshpass -p "$(SFTP_PASSWORD)" scp -o StrictHostKeyChecking=no \
        $(Build.ArtifactStagingDirectory)/artifact3.txt azureuser@$(SFTP_SERVER_IP):/sftp/uploads/artifact3.txt
    displayName: 'Copy to SFTP Server'
    env:
      SFTP_PASSWORD: $(sftp_password)
      SFTP_SERVER_IP: $(sftp_server_ip)

  # Step 7: Copy artifact from SFTP server to deploymachine VM
  - script: |
      sshpass -p "$(DEPLOYMACHINE_PASSWORD)" scp -o StrictHostKeyChecking=no \
        azureuser@$(SFTP_SERVER_IP):/sftp/uploads/artifact3.txt coditas@deploymachine:/home/coditas/
    displayName: 'Copy Artifact to deploymachine VM'
    env:
      DEPLOYMACHINE_PASSWORD: $(deploymachine_password)
      SFTP_SERVER_IP: $(sftp_server_ip)


