trigger:
- main

pool:
  vmImage: "SelfHostedAgents"  # Use an Ubuntu-based agent now

steps:
- task: DownloadSecureFile@1
  name: downloadSFTPKey
  displayName: "Download SFTP Private Key"
  inputs:
    secureFile: "sftpserver_key.pem"

- script: |
    chmod 600 $(Agent.TempDirectory)/sftpserver_key.pem
    echo "StrictHostKeyChecking no" >> ~/.ssh/config
  displayName: "Set up SSH Key"

- script: |
    ssh -i $(Agent.TempDirectory)/sftpserver_key.pem azureuser@13.71.109.194 "echo 'Connected to SFTP Server!'"
  displayName: "Test SSH Connection to SFTP Server"

- script: |
    sudo apt-get update && sudo apt-get install -y sshpass
    sshpass -p "$(CODITAS_DEPLOY_PASS)" scp /sftp/uploads/file.txt coditas@deploymachine:/home/coditas
  displayName: "Transfer File to Deploy Machine"
  env:
    CODITAS_DEPLOY_PASS: $(CODITAS_DEPLOY_PASS)  # Securely stored password
